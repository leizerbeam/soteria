apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: enforce-data-protection-by-label
  annotations:
    policies.kyverno.io/title: Enforce By Label
    policies.kyverno.io/category: K10
    policies.kyverno.io/subject: StatefulSet
    policies.kyverno.io/description: >-
      Check the dataprotection labels for production Deployments and StatefulSet have a named K10 Policy.
      Use in combination with generate ClusterPolicy to generate a specific K10 Policy by name.
spec:
  validationFailureAction: enforce
  rules:
  - name: enforce-data-protection-by-label
    match:
      resources:
        kinds:
        - Deployment
        - StatefulSet
    validate:
      message: "Production Deployments and StatefulSets must have Data Protection Policies assigned (use labels: dataprotection: k10-<policyname>)"
      pattern:
        metadata:
          labels:
            =(purpose): production
            dataprotection: k10-?*
            immutable: enabled